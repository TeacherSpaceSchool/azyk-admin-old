{"ast":null,"code":"import _objectSpread from \"@babel/runtime-corejs2/helpers/esm/objectSpread\";\n\n/* eslint-disable no-extra-boolean-cast */\nimport { urlGQL, urlGQLws } from '../../redux/constants/other';\nimport { ApolloClient } from 'apollo-client';\nimport { InMemoryCache } from 'apollo-cache-inmemory';\nimport fetch from 'node-fetch';\nimport { getJWT } from '../lib';\nimport { setContext } from 'apollo-link-context';\nimport { onError } from 'apollo-link-error';\nimport { ApolloLink, split } from 'apollo-link';\nimport { createUploadLink } from 'apollo-upload-client'; //import { WebSocketLink } from 'apollo-link-ws';\n\nimport { getMainDefinition } from 'apollo-utilities'; //import * as ws from 'ws';\n\nimport { SingletonStore } from '../singleton/store';\nimport { showSnackBar } from '../../redux/actions/snackbar';\nexport class SingletonApolloClient {\n  constructor(req) {\n    if (!!SingletonApolloClient.instance) {\n      return SingletonApolloClient.instance;\n    }\n\n    SingletonApolloClient.instance = this;\n    const uploadLink = createUploadLink({\n      uri: urlGQL,\n      fetch: fetch,\n      credentials: 'include'\n    });\n    const authLink = setContext((_, {\n      headers\n    }) => {\n      return {\n        headers: _objectSpread({}, headers, {\n          authorization: this.jwt ? `Bearer ${this.jwt}` : ''\n        })\n      };\n    });\n    const linkError = onError(ctx => {\n      if (ctx.graphQLErrors) ctx.graphQLErrors.map(({\n        message,\n        locations,\n        path\n      }) => {\n        new SingletonStore().getStore().dispatch(showSnackBar('Ошибка'));\n        console.log(`[GraphQL error]: Message: ${message}, Location: ${locations}, Path: ${path}`);\n      });\n      if (ctx.networkError) console.log(`[Network error]: ${ctx.networkError}`);\n    });\n    /*const wsLink = new WebSocketLink({\r\n        uri: urlGQLws,\r\n        options: {\r\n            reconnect: true\r\n        },\r\n        webSocketImpl: process.browser?WebSocket:ws\r\n    });*/\n\n    const mainLink =\n    /*split(\r\n    ({ query }) => {\r\n    const definition = getMainDefinition(query);\r\n    return (\r\n    definition.kind === 'OperationDefinition' &&\r\n    definition.operation === 'subscription'\r\n    );\r\n    },\r\n    wsLink,*/\n    uploadLink;\n    /*,\r\n    );*/\n\n    const link = ApolloLink.from([linkError, authLink, mainLink]);\n    this.client = new ApolloClient({\n      link: link,\n      cache: new InMemoryCache(),\n      defaultOptions: {\n        watchQuery: {\n          fetchPolicy: 'cache-and-network',\n          errorPolicy: 'ignore'\n        },\n        query: {\n          fetchPolicy: 'network-only',\n          errorPolicy: 'all'\n        },\n        mutate: {\n          errorPolicy: 'all'\n        }\n      }\n    });\n    this.jwt = getJWT(req ? req.headers.cookie : document.cookie);\n    return this;\n  }\n\n  getClient() {\n    return this.client;\n  }\n\n}","map":null,"metadata":{},"sourceType":"module"}