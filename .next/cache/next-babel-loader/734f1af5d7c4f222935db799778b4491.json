{"ast":null,"code":"import _objectSpread from \"@babel/runtime-corejs2/helpers/esm/objectSpread\";\n\n/* eslint-disable no-extra-boolean-cast */\nimport { urlGQL, urlGQLws } from '../../redux/constants/other';\nimport { ApolloClient } from 'apollo-client';\nimport { InMemoryCache } from 'apollo-cache-inmemory';\nimport fetch from 'node-fetch';\nimport { getJWT } from '../lib';\nimport { setContext } from 'apollo-link-context';\nimport { onError } from 'apollo-link-error';\nimport { ApolloLink, split } from 'apollo-link';\nimport { createUploadLink } from 'apollo-upload-client';\nimport { WebSocketLink } from 'apollo-link-ws';\nimport { getMainDefinition } from 'apollo-utilities';\nimport * as ws from 'ws';\nimport { SingletonStore } from '../singleton/store';\nimport { showSnackBar } from '../../redux/actions/snackbar';\nexport class SingletonApolloClient {\n  constructor(req) {\n    if (!!SingletonApolloClient.instance) {\n      return SingletonApolloClient.instance;\n    }\n\n    SingletonApolloClient.instance = this;\n    const uploadLink = createUploadLink({\n      uri: urlGQL,\n      fetch: fetch,\n      credentials: 'include'\n    });\n    const authLink = setContext((_, {\n      headers\n    }) => {\n      return {\n        headers: _objectSpread({}, headers, {\n          authorization: this.jwt ? `Bearer ${this.jwt}` : ''\n        })\n      };\n    });\n    const linkError = onError(({\n      graphQLErrors,\n      networkError\n    }) => {\n      if (graphQLErrors) graphQLErrors.map(({\n        message,\n        locations,\n        path\n      }) => {\n        new SingletonStore().getStore().dispatch(showSnackBar('Ошибка'));\n        console.log(`[GraphQL error]: Message: ${message}, Location: ${locations}, Path: ${path}`);\n      });\n      if (networkError) console.log(`[Network error]: ${networkError}`);\n    });\n    const wsLink = new WebSocketLink({\n      uri: urlGQLws,\n      options: {\n        reconnect: true\n      },\n      webSocketImpl: process.browser ? WebSocket : ws\n    });\n    const mainLink = split(({\n      query\n    }) => {\n      const definition = getMainDefinition(query);\n      return definition.kind === 'OperationDefinition' && definition.operation === 'subscription';\n    }, wsLink, uploadLink);\n    const link = ApolloLink.from([linkError, authLink, mainLink]);\n    this.client = new ApolloClient({\n      link: link,\n      cache: new InMemoryCache(),\n      defaultOptions: {\n        watchQuery: {\n          fetchPolicy: 'cache-and-network',\n          errorPolicy: 'ignore'\n        },\n        query: {\n          fetchPolicy: 'network-only',\n          errorPolicy: 'all'\n        },\n        mutate: {\n          errorPolicy: 'all'\n        }\n      }\n    });\n    this.jwt = getJWT(req ? req.headers.cookie : document.cookie);\n    return this;\n  }\n\n  getClient() {\n    return this.client;\n  }\n\n}","map":null,"metadata":{},"sourceType":"module"}