{"ast":null,"code":"import _objectSpread from \"@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\n\n/* eslint-disable no-extra-boolean-cast */\nimport { urlGQL, urlGQLws } from '../../redux/constants/other';\nimport { ApolloClient } from 'apollo-client';\nimport { InMemoryCache } from 'apollo-cache-inmemory';\nimport fetch from 'node-fetch';\nimport { getJWT } from '../lib';\nimport { setContext } from 'apollo-link-context';\nimport { onError } from 'apollo-link-error';\nimport { ApolloLink, split } from 'apollo-link';\nimport { createUploadLink } from 'apollo-upload-client'; //import { WebSocketLink } from 'apollo-link-ws';\n\nimport { getMainDefinition } from 'apollo-utilities'; //import * as ws from 'ws';\n\nimport { SingletonStore } from '../singleton/store';\nimport { showSnackBar } from '../../redux/actions/snackbar';\nexport var SingletonApolloClient =\n/*#__PURE__*/\nfunction () {\n  function SingletonApolloClient(req) {\n    var _this = this;\n\n    _classCallCheck(this, SingletonApolloClient);\n\n    if (!!SingletonApolloClient.instance) {\n      return SingletonApolloClient.instance;\n    }\n\n    SingletonApolloClient.instance = this;\n    var uploadLink = createUploadLink({\n      uri: urlGQL,\n      fetch: fetch,\n      credentials: 'include'\n    });\n    var authLink = setContext(function (_, _ref) {\n      var headers = _ref.headers;\n      return {\n        headers: _objectSpread({}, headers, {\n          authorization: _this.jwt ? \"Bearer \".concat(_this.jwt) : ''\n        })\n      };\n    });\n    var linkError = onError(function (ctx) {\n      if (ctx.graphQLErrors) ctx.graphQLErrors.map(function (_ref2) {\n        var message = _ref2.message,\n            locations = _ref2.locations,\n            path = _ref2.path;\n        new SingletonStore().getStore().dispatch(showSnackBar('Ошибка'));\n        console.log(\"[GraphQL error]: Message: \".concat(message, \", Location: \").concat(locations, \", Path: \").concat(path));\n      });\n      if (ctx.networkError) console.log(\"[Network error]: \".concat(ctx.networkError));\n    });\n    /*const wsLink = new WebSocketLink({\r\n        uri: urlGQLws,\r\n        options: {\r\n            reconnect: true\r\n        },\r\n        webSocketImpl: process.browser?WebSocket:ws\r\n    });*/\n\n    var mainLink =\n    /*split(\r\n    ({ query }) => {\r\n    const definition = getMainDefinition(query);\r\n    return (\r\n    definition.kind === 'OperationDefinition' &&\r\n    definition.operation === 'subscription'\r\n    );\r\n    },\r\n    wsLink,*/\n    uploadLink;\n    /*,\r\n    );*/\n\n    var link = ApolloLink.from([linkError, authLink, mainLink]);\n    this.client = new ApolloClient({\n      link: link,\n      cache: new InMemoryCache(),\n      defaultOptions: {\n        watchQuery: {\n          fetchPolicy: 'cache-and-network',\n          errorPolicy: 'ignore'\n        },\n        query: {\n          fetchPolicy: 'network-only',\n          errorPolicy: 'all'\n        },\n        mutate: {\n          errorPolicy: 'all'\n        }\n      }\n    });\n    this.jwt = getJWT(req ? req.headers.cookie : document.cookie);\n    return this;\n  }\n\n  _createClass(SingletonApolloClient, [{\n    key: \"getClient\",\n    value: function getClient() {\n      return this.client;\n    }\n  }]);\n\n  return SingletonApolloClient;\n}();","map":null,"metadata":{},"sourceType":"module"}